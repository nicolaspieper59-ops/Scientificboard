<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cockpit Cosmique</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      margin:0;
      background: radial-gradient(circle at center, #000 0%, #111 100%);
      color:#0ff;
      font-family: system-ui, sans-serif;
    }
    header {
      padding:0.5rem 1rem;
      border-bottom:1px solid #333;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .badge {
      border:1px solid #555;
      border-radius:999px;
      padding:0.2rem 0.5rem;
      font-size:0.8rem;
    }
    #grid {
      display:grid;
      gap:0.75rem;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      padding:1rem;
    }
    .card {
      background:#0a0a0a;
      border:1px solid #111;
      border-radius:8px;
      padding:0.75rem;
    }
    .card h3 {
      margin-top:0;
      font-size:1rem;
      color:#9ff;
    }
    .row {
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
    }
    .toggle {
      background:#012;
      color:#9ff;
      border:1px solid #024;
      border-radius:8px;
      padding:0.4rem 0.6rem;
      cursor:pointer;
    }
    .toggle.active { background:#024; }
    #log {
      max-height:150px;
      overflow:auto;
      font-size:0.8rem;
      background:#050;
      padding:0.5rem;
      border-radius:6px;
    }
    canvas {
      display:block;
      width:100%;
      height:200px;
      background:#020;
      border:1px solid #033;
      border-radius:8px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <strong>🌌 Cockpit Cosmique</strong>
      <span class="badge" id="cycleBadge">cycle: …</span>
      <span class="badge" id="phaseBadge">lune: …</span>
    </div>
    <div class="row">
      <button id="btnInstall" class="hidden">Installer</button>
      <button id="btnExport">Exporter journal</button>
    </div>
  </header>

  <main id="grid">
    <!-- Modules internes -->
    <section class="card"><h3>🌞 Heure solaire locale</h3><div id="solarTimes">—</div></section>
    <section class="card"><h3>🧭 Boussole + niveau</h3><div id="compassVal">—</div></section>
    <section class="card"><h3>🛰️ GPS + vitesse</h3><div id="gpsVal">—</div></section>
    <section class="card"><h3>💡 Lumière ambiante</h3><div id="luxVal">—</div></section>
    <section class="card"><h3>🔊 Son ambiant</h3><div id="audioLevel">—</div></section>
    <section class="card"><h3>🧲 Champ magnétique</h3><div id="magVal">—</div></section>

    <!-- Modules connectés -->
    <section class="card"><h3>🌊 Marées</h3><div id="tideVal">—</div></section>
    <section class="card"><h3>✨ Événements célestes</h3><div id="celesteVal">—</div></section>

    <!-- Capteurs externes -->
    <section class="card"><h3>🌞 UV</h3><div id="uvVal">—</div></section>
    <section class="card"><h3>🌫️ CO₂</h3><div id="co2Val">—</div></section>
    <section class="card"><h3>🧿 Résonance Schumann</h3><div id="schumannVal">—</div></section>

    <!-- Artistiques -->
    <section class="card"><h3>🎼 Ambiance sonore</h3><button id="btnAmbient">Activer</button></section>
    <section class="card"><h3>🌀 Visualisation orbitale</h3><canvas id="canvasOrbit"></canvas></section>

    <!-- Panneau interactif -->
    <section class="card">
      <h3>🎛️ Panneau cosmique</h3>
      <div class="row">
        <div class="toggle" id="tgInvLever">Invoc. lever</div>
        <div class="toggle" id="tgInvZenith">Invoc. zénith</div>
        <div class="toggle" id="tgInvCoucher">Invoc. coucher</div>
        <div class="toggle" id="tgInvMaree">Invoc. marées</div>
        <div class="toggle" id="tgInvCeleste">Invoc. céleste</div>
        <div class="toggle" id="tgInvUV">Invoc. UV haut</div>
        <div class="toggle" id="tgInvCO2">Invoc. CO₂ haut</div>
      </div>
    </section>

    <!-- Journal -->
    <section class="card"><h3>📈 Historique</h3><div id="log"></div></section>
                                                           </main>
  <script>
  // 🧠 Bus d’événements
  const Bus = (() => {
    const map = new Map();
    return {
      on: (evt, cb) => (map.has(evt) ? map.get(evt).push(cb) : map.set(evt, [cb])),
      emit: (evt, data) => (map.get(evt) || []).forEach(cb => cb(data))
    };
  })();

  // ⚙️ Préférences
  const Pref = {
    get: (k, v = null) => JSON.parse(localStorage.getItem(k) ?? JSON.stringify(v)),
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
  };

  // 🌞 Calculs solaires
  function toRad(x) { return x * Math.PI / 180 }
  function julianDay(d) { return (d / 86400000) + 2440587.5 }
  function solarNoonUTC(d, lon) {
    const J = Math.floor(julianDay(d) - 0.5) + 0.5;
    const n = Math.round(J - 2451545 - lon / 360);
    const Jstar = 2451545 + n - lon / 360;
    const M = toRad((357.5291 + 0.98560028 * (Jstar - 2451545)) % 360);
    const C = 1.9148 * Math.sin(M) + 0.0200 * Math.sin(2 * M) + 0.0003 * Math.sin(3 * M);
    const λ = toRad((280.1470 + 0.98564736 * (Jstar - 2451545) + C) % 360);
    const Jtransit = Jstar + 0.0053 * Math.sin(M) - 0.0069 * Math.sin(2 * λ);
    return (Jtransit - 2440587.5) * 86400000;
  }
  function sunriseSunset(d, lat, lon, angle = -0.83) {
    const noonMs = solarNoonUTC(d, lon);
    const noon = new Date(noonMs);
    const δ = (() => {
      const J = julianDay(noon);
      const n = Math.round(J - 2451545 - lon / 360);
      const M = toRad((357.5291 + 0.98560028 * n) % 360);
      const C = 1.9148 * Math.sin(M) + 0.0200 * Math.sin(2 * M) + 0.0003 * Math.sin(3 * M);
      const λ = toRad((280.1470 + 0.98564736 * n + C) % 360);
      return Math.asin(Math.sin(λ) * Math.sin(toRad(23.44)));
    })();
    const ω = Math.acos(
      (Math.sin(toRad(angle)) - Math.sin(toRad(lat)) * Math.sin(δ)) /
      (Math.cos(toRad(lat)) * Math.cos(δ))
    );
    const dayLengthMs = (2 * ω * 180 / Math.PI) / 15 * 3600000;
    return {
      sunrise: new Date(noonMs - dayLengthMs / 2),
      solarNoon: noon,
      sunset: new Date(noonMs + dayLengthMs / 2)
    };
  }

  // 🌙 Phase lunaire
  function getPhaseLunaire() {
    const jd = julianDay(Date.now());
    const phase = ((jd - 2451550.1) / 29.53058867) % 1;
    return phase < 0.25 ? 'nouvelle' : phase < 0.5 ? 'croissante' : phase < 0.75 ? 'pleine' : 'décroissante';
  }

  // 🧭 Cycle solaire/lunaire
  function getCycleCosmique() {
    const h = new Date().getHours();
    return (h >= 6 && h < 18) ? 'solaire' : 'lunaire';
  }

  // 🕒 Mise à jour des badges
  function updateCycleBadges() {
    document.getElementById('cycleBadge').textContent = `cycle: ${getCycleCosmique()}`;
    document.getElementById('phaseBadge').textContent = `lune: ${getPhaseLunaire()}`;
  }
  updateCycleBadges();

  // 🔁 Moteur d’invocation automatique
  let lastKeys = new Set();
  async function getCtx() {
    const now = new Date();
    let lat = 43.3, lon = 5.4; // Marseille par défaut
    try {
      const pos = await new Promise(res => navigator.geolocation?.getCurrentPosition(
        p => res(p), _ => res(null), { enableHighAccuracy: true, maximumAge: 60000, timeout: 3000 }
      ));
      if (pos) { lat = pos.coords.latitude; lon = pos.coords.longitude; }
    } catch {}
    const solar = sunriseSunset(now, lat, lon);
    return { now, solar, lat, lon };
  }

  const Rules = {
    lever: ctx => (ctx.now >= ctx.solar.sunrise && ctx.now - ctx.solar.sunrise < 5 * 60 * 1000),
    zenith: ctx => Math.abs(ctx.now - ctx.solar.solarNoon) < 5 * 60 * 1000,
    coucher: ctx => (ctx.now >= ctx.solar.sunset && ctx.now - ctx.solar.sunset < 5 * 60 * 1000)
  };

  async function tickInvocation() {
    const ctx = await getCtx();
    const tests = [
      { k: 'lever', f: Rules.lever, tag: 'invoke:solaire:lever' },
      { k: 'zenith', f: Rules.zenith, tag: 'invoke:solaire:zenith' },
      { k: 'coucher', f: Rules.coucher, tag: 'invoke:solaire:coucher' }
    ];
    for (const t of tests) {
      const windowKey = t.k + ':' + Math.floor(Date.now() / 300000);
      const enabled = Pref.get('tgInv' + t.k.charAt(0).toUpperCase() + t.k.slice(1), true);
      if (enabled && t.f(ctx) && !lastKeys.has(windowKey)) {
        Bus.emit(t.tag, ctx);
        lastKeys.add(windowKey);
        log(`invocation:${t.k}`);
      }
    }
    // Mise à jour affichage solaire
    document.getElementById('solarTimes').textContent =
      `Lever: ${ctx.solar.sunrise.toLocaleTimeString()} — Zénith: ${ctx.solar.solarNoon.toLocaleTimeString()} — Coucher: ${ctx.solar.sunset.toLocaleTimeString()}`;
  }
  setInterval(tickInvocation, 30000);
  tickInvocation();
  </script>
  
          
